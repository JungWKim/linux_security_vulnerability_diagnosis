#!/bin/bash

#----- U-01. 루트 원격 접속 제한(상)
sed -i ‘s/#PermitRootLogin yes/PermitRootLogin no/g’ /etc/ssh/sshd_config
sed -i '/pts/ s/^/#/' /etc/securetty

# PAM 모듈 동작시 해당 위치의 공유 라이브러리를 참조함
sed -i'' -r -e '/auth include postlogin/a\auth required /usr/lib64/security/pam_securetty.so' /etc/pam.d/login

#----- U-02. 패스워드 복잡성 설정(상)

# 패스워드 최소길이 8자리
sed -i ‘s/# minlen = 8/minlen = 9/g’ /etc/security/pwquality.conf
echo "PASS_MIN_LEN 9" >> /etc/login.defs

# 패스워드 소문자 최소 1개
sed -i ‘s/# lcredit = 1/lcredit = -1/g’ /etc/security/pwquality.conf

# 패스워드 대문자 최소 1개
sed -i ‘s/# ucredit = 1/ucredit = -1/g’ /etc/security/pwquality.conf

# 패스워드 숫자 최소 1개
sed -i ‘s/# dcredit = 1/dcredit = -1/g’ /etc/security/pwquality.conf

# 패스워드 특수문자 최소 1개
sed -i ‘s/# ocredit = 1/ocredit = -1/g’ /etc/security/pwquality.conf

#----- U-03. 계정 잠금 임계값 설정 / 로그인 실패 횟수(상)

# no_magic_root :  루트에게는 패스워드 잠금 설정을 적용하지 않음
# unlock_time : 마지막 계정 실패로부터 계정 로그인이 잠기는 시간
# reset : 접속 시도 성공 시 실패한 횟수 초기화
# deny : 특정 횟수 입력 실패 시 패스워드 잠금(10회 이하로 설정되어야함)
# even_deny_root : no_magic_root와 정반대로, 루트에게도 패스워드 잠금 설정을 적용

# /etc/pam.d/system-auth : 콘솔 로그인 또는 su 전환시
# /etc/pam.d/password-auth : GUI 로그인 또는 ssh 로그인

sed -i'' -r -e '/auth required pam_deny.so/a\auth required pam_tally2.so deny=5 unlock_time=120 even_deny_root' /etc/pam.d/system-auth
sed -i'' -r -e '/auth required pam_permit.so/a\account required pam_tally2.so even_deny_root reset' /etc/pam.d/system-auth
sed -i'' -r -e '/auth required pam_deny.so/a\auth required pam_tally2.so deny=5 unlock_time=120 even_deny_root' /etc/pam.d/password-auth
sed -i'' -r -e '/auth required pam_permit.so/a\account required pam_tally2.so even_deny_root reset"' /etc/pam.d/password-auth

#----- U-04. 패스워드 파일 보호(상)

# CentOS 7.9는 기본적으로 계정 비밀번호는 암호화가 되어서 /etc/passwd 파일 내 두 번째 필드가 X 표시된다.

#----- U-05. root 홈, 패스 디렉터리 권한 및 패스 설정(상)

# PATH의 맨 앞 또는 중간에 '.' 또는 '::'이 없어야함

#----- U-06. 파일 및 디렉토리 소유자 설정(상)

# 소유자가 존재하지 않는 파일 및 디렉토리는 삭제 또는 소유자 변경
NOUSER=$(find / -nouser -print)
NOGROUP=$(find / -nogroup -print)

for FILE in $NOUSER ; do
	echo "file with no owner : ${FILE}"
done

for FILE in $NOGROUP ; do
	echo "file with no group : ${FILE}"
done

#----- U-07./etc/passwd 파일 소유자 및 권한 설정(상)
chmod 644 /etc/passwd
chown root /etc/passwd

#----- U-08. /etc/shadow 파일 소유자 및 권한 설정(상)
chmod 400 /etc/shadow
chown root /etc/shadow

#----- U-09. /etc/hosts 파일 소유자 및 권한 설정(상)
chmod 600 /etc/hosts
chown root /etc/hosts

#----- U-10. /etc/xinetd.conf 파일 소유자 및 권한 설정(상)
chown -R root /etc/xinetd.d
chmod 600 /etc/xinetd.d

#----- U-11. /etc/rsyslog.conf 파일 소유자 및 권한 설정(상)
# 소유자는 bin, sys여도 무방
# 로그를 기록하지 않도록 하거나, 대량 로그 발생시켜 과부하 유도 가능
chmod 644 /etc/rsyslog.conf
chown root /etc/rsyslog.conf

#----- U-12. /etc/services 파일 소유자 및 권한 설정(상)
# 비인가자의 포트 변경 방지
chmod 644 /etc/services
chown root /etc/services

#----- U-13. SUID, SGID, 설정 파일점검(상)
LIST=find / -user root -type f \( -perm -04000 -o -perm -02000 \) -xdev -exec ls –al {} \;
for FILE in $LIST ; do
	chmod -s $FILE
done
chmod -s /usr/sbin/unix_chkpwd
chmod -s /usr/bin/newgrp
chmod -s /usr/bin/at

#----- U-14. 사용자, 시스템 시작파일 및 환경파일 소유자 및 권한 설정
# 계정 별 .bashrc, .bash_profile, .cshrc, .tcshrc 등의 소유자가 루트 또는 해당 사용자이거나, 루트 또는 소유자만 쓰기권한이 부여되어야함

#----- U-15. world writable 파일 점검
# world writable  파일의 일반 사용자 쓰기권한을 제거하거나 아예 파일을 삭제. 아래 명령어로 탐색
# find / -type f -perm -2 -exec ls -l {} \;

#----- U-42. 최신 보안패치 및 벤더 권고사항 적용(상)
# ssh 버전은 최소 7.6이어야함
# GUI에서는 SSH  버전을 7.4로 유지해야함
yum remove openssh.x86_64
tar -xf openssh-7.6p1.tar.gz
cd openssh-7.6p1
./configure --prefix=/usr --sysconfdir=/etc/ssh -with-md5-passwords -with-pam -without-hardening
make
make install
cd ..

#----- U-45. root 계정 su 제한(하)
sed -i'' -r -e '/pam_wheel.so use_uid/a\auth required /usr/lib64/security/pam_wheel.so debug group=wheel' /etc/pam.d/su
chmod 4750 /usr/bin/su
chgrp wheel /usr/bin/su
chmod 4750 /bin/su
chgrp wheel /bin/su
usermod -aG wheel root

#----- U-47. 패스워드 최대 사용기간 설정(중)
echo "PASS_MAX_DAYS 70" >> /etc/login.defs

#----- U-48. 패스워드 최소 사용기간 설정(중)
echo "PASS_MIN_DAYS 7" >> /etc/login.defs
echo "PASS_WARN_AGE 7" >> /etc/login.defs

#----- U-54. session timeout 설정(하)
echo "TMOUT=600" >> /etc/profile
echo "export TMOUT" >> /etc/profile

#----- U-68. 로그온 시 경고 메세지 제공(하)
cat > /etc/motd <<EOF
-------------------------------------------------------------
This system is strictly restricted to the authorized people.
Any illegal access shall be punished with a related-law!
-------------------------------------------------------------
EOF

cat > /etc/issue.net <<EOF
-------------------------------------------------------------
This system is strictly restricted to the authorized people.
Any illegal access shall be punished with a related-law!
-------------------------------------------------------------
EOF

#----- U-72. 정책에 따른 시스템 로깅 설정(하)
echo "SULOG_FILE /var/log/sulog" >> /etc/login.defs

echo "*.info;mail.none;authpriv.none;cron.none /var/log/messages" >> /etc/rsyslog.conf
echo "authpriv.* /var/log/secure" >> /etc/rsyslog.conf
echo "mail.* /var/log/maillog" >> /etc/rsyslog.conf
echo "cron.* /var/log/cron" >> /etc/rsyslog.conf
echo "*.alert /dev/console" >> /etc/rsyslog.conf
echo "auth.info /var/log/sulog" >> /etc/rsyslog.conf

#----- U-extra1. IP 포워딩 비활성화
echo 0 > /proc/sys/net/ipv4/ip_forward
echo 0 > /proc/sys/net/ipv4/ip_forward

echo 0 > /proc/sys/net/ipv4/conf/all/accept_redirects
echo 0 > /proc/sys/net/ipv4/conf/all/send_redirects
echo 0 > /proc/sys/net/ipv4/conf/default/accept_redirects
echo 0 > /proc/sys/net/ipv4/conf/default/send_redirects
echo 0 > /proc/sys/net/ipv4/conf/docker0/accept_redirects
echo 0 > /proc/sys/net/ipv4/conf/docker0/send_redirects
echo 0 > /proc/sys/net/ipv4/conf/eno1/accept_redirects
echo 0 > /proc/sys/net/ipv4/conf/eno1/send_redirects
echo 0 > /proc/sys/net/ipv4/conf/eno2/accept_redirects
echo 0 > /proc/sys/net/ipv4/conf/eno2/send_redirects
echo 0 > /proc/sys/net/ipv4/conf/lo/accept_redirects
echo 0 > /proc/sys/net/ipv4/conf/lo/send_redirects
echo 0 > /proc/sys/net/ipv4/conf/usb0/accept_redirects
echo 0 > /proc/sys/net/ipv4/conf/usb0/send_redirects

echo 0 > /proc/sys/net/ipv6/conf/all/accept_redirects
echo 0 > /proc/sys/net/ipv6/conf/default/accept_redirects
echo 0 > /proc/sys/net/ipv6/conf/docker0/accept_redirects
echo 0 > /proc/sys/net/ipv6/conf/eno1/accept_redirects
echo 0 > /proc/sys/net/ipv6/conf/eno2/accept_redirects
echo 0 > /proc/sys/net/ipv6/conf/lo/accept_redirects
echo 0 > /proc/sys/net/ipv6/conf/usb0/accept_redirects

echo "net.ipv4.ip_forward=0" >> /etc/sysctl.conf
echo "net.ipv4.conf.default.accept_source_route=0" >> /etc/sysctl.conf

echo "net.ipv4.conf.all.accept_redirects=0"
echo "net.ipv4.conf.all.send_redirects=0"
echo "net.ipv4.conf.default.accept_redirects=0"
echo "net.ipv4.conf.default.send_redirects=0"
echo "net.ipv4.conf.docker0.accept_redirects=0"
echo "net.ipv4.conf.docker0.send_redirects=0"
echo "net.ipv4.conf.eno1.accept_redirects=0"
echo "net.ipv4.conf.eno1.send_redirects=0"
echo "net.ipv4.conf.eno2.accept_redirects=0"
echo "net.ipv4.conf.eno2.send_redirects=0"
echo "net.ipv4.conf.lo.accept_redirects=0"
echo "net.ipv4.conf.lo.send_redirects=0"
echo "net.ipv4.conf.usb0.accept_redirects=0"
echo "net.ipv4.conf.usb0.send_redirects=0"

echo "net.ipv6.conf.all.accept_redirects=0"
echo "net.ipv6.conf.default.accept_redirects=0"
echo "net.ipv6.conf.docker0.accept_redirects=0"
echo "net.ipv6.conf.eno1.accept_redirects=0"
echo "net.ipv6.conf.eno2.accept_redirects=0"
echo "net.ipv6.conf.lo.accept_redirects=0"
echo "net.ipv6.conf.usb0.accept_redirects=0"

